<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laberinto de Amor</title>
  <style>
    body {
      margin: 0;
      background-color: #fcefee;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }

    #game {
      position: relative;
      display: grid;
      grid-template-columns: repeat(20, 40px);
      grid-template-rows: repeat(21, 40px);
      gap: 2px;
      background-color: #f8e1e7;
      padding: 10px;
      border-radius: 20px;
      box-shadow: 0 0 25px rgba(0,0,0,0.1);
    }

    .cell {
      width: 40px;
      height: 40px;
      background-color: #f8e1e7;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: transform 0.2s ease, background-color 0.3s;
      position: relative;
    }

    .visited {
      background-color: #ffe4ec;
    }

    .wall {
      background-color: #b68aad;
    }

    .player {
      background-color: transparent;
      font-size: 26px;
      animation: bounce 0.8s infinite alternate ease-in-out;
      transform: scale(1.2);
    }

    .end {
      background-color: transparent;
      font-size: 26px;
      animation: pulse 1.5s infinite ease-in-out;
      transform-origin: center;
    }

    @keyframes bounce {
      from { transform: translateY(0) scale(1.2); }
      to   { transform: translateY(-6px) scale(1.25); }
    }
    @keyframes pulse {
      0%   { transform: scale(1);   opacity: 1; }
      50%  { transform: scale(1.3); opacity: 0.9; }
      100% { transform: scale(1);   opacity: 1; }
    }

    .sparkle {
      position: absolute;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: #fff;
      animation: sparkleMove 0.8s ease-out forwards;
      pointer-events: none;
      z-index: 5;
    }
    @keyframes sparkleMove {
      to {
        transform: translateY(-20px) scale(0);
        opacity: 0;
      }
    }

    #message {
      position: absolute;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255,255,255,0.95);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 10;
      cursor: pointer;
    }

    #message img {
      max-width: 90%;
      max-height: 80vh;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
      animation: fadeIn 2s ease;
    }

    #restart {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 18px;
      background-color: #f6d186;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      transition: background-color 0.3s;
    }
    #restart:hover {
      background-color: #e5c066;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to   { opacity: 1; transform: scale(1); }
    }

    .confetti {
      position: absolute;
      top: -10px;
      width: 8px; height: 8px;
      border-radius: 50%;
      animation: fall linear;
      z-index: 20;
    }
    @keyframes fall {
      to {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }

    #flash {
      position: absolute;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: #fff;
      opacity: 0;
      pointer-events: none;
      z-index: 50;
      animation: flashAnim 0.5s ease-out forwards;
    }
    @keyframes flashAnim {
      0%   { opacity: 1; }
      100% { opacity: 0; }
    }

    .heart {
      position: absolute;
      font-size: 24px;
      opacity: 0.8;
      animation: heartFloat 3s ease-out forwards;
      pointer-events: none;
      z-index: 15;
    }
    @keyframes heartFloat {
      0%   { transform: translateY(0) scale(1); }
      100% { transform: translateY(-300px) scale(1.5); opacity: 0; }
    }

    .sparkle-large {
      position: absolute;
      width: 12px; height: 12px;
      border-radius: 50%;
      background-color: #fff;
      opacity: 0.9;
      animation: largeSparkle 1s ease-out forwards;
      pointer-events: none;
      z-index: 5;
    }
    @keyframes largeSparkle {
      to {
        transform: translateY(-50px) scale(2);
        opacity: 0;
      }
    }
  </style>
</head>
<body>

  <div id="game"></div>

  <div id="message">
    <img id="final-card" src="cancion.png" alt="Carta de cumpleaÃ±os" />
    <audio id="loveSong" src="De a Dos.mp3"></audio>
    <button id="restart">Volver</button>
  </div>

  <audio id="moveSound" src="bue.ogg" preload="auto"></audio>

  <script>
    const map = [
      "####################",
      "#     #     #      #",
      "# ### # ### # #### #",
      "# #   #   # #    # #",
      "# # ##### # #### # #",
      "# #     # # #    # #",
      "# ##### # # # #### #",
      "#     # # # #      #",
      "##### # # # ########",
      "#   # # #        # #",
      "# # # # ####### ## #",
      "# # # #     #      #",
      "# # ##### ### ######",
      "# #     #     #    #",
      "# ### # ##### # ## #",
      "#   # #     # # ## #",
      "##### ##### # #    #",
      "#   #     #   ######",
      "######### ########E#",
      "#                  #",
      "####################"
    ];
    const cols = map[0].length;

    const game      = document.getElementById("game");
    const message   = document.getElementById("message");
    const moveSound = document.getElementById("moveSound");
    const finalCard = document.getElementById("final-card");
    const loveSong  = document.getElementById("loveSong");
    const restart   = document.getElementById("restart");

    let playerX = 1, playerY = 1;
    let visited = new Set([`${playerX},${playerY}`]);

    function drawMap() {
      game.innerHTML = "";
      for (let y = 0; y < map.length; y++) {
        for (let x = 0; x < cols; x++) {
          const cell = document.createElement("div");
          cell.classList.add("cell");
          if (map[y][x] === "#") {
            cell.classList.add("wall");
          } else if (visited.has(`${x},${y}`)) {
            cell.classList.add("visited");
          }

          if (x === playerX && y === playerY) {
            cell.classList.add("player");
            cell.textContent = "â¤ï¸";
          } else if (map[y][x] === "E") {
            cell.classList.add("end");
            cell.textContent = "ðŸŽ‚";
          }

          game.appendChild(cell);
        }
      }
    }

    function spawnSparkle(x, y) {
      const idx = y * cols + x;
      const cellEl = game.children[idx];
      const rect   = cellEl.getBoundingClientRect();
      const s = document.createElement("div");
      s.className = "sparkle";
      s.style.left = rect.left + rect.width/2 + "px";
      s.style.top  = rect.top  + rect.height/2 + "px";
      document.body.appendChild(s);
      setTimeout(() => s.remove(), 800);
    }

    function spawnLargeSparkles(amount) {
      for (let i = 0; i < amount; i++) {
        const ll = document.createElement("div");
        ll.className = "sparkle-large";
        ll.style.left = Math.random()*100 + "vw";
        ll.style.top  = Math.random()*100 + "vh";
        document.body.appendChild(ll);
        setTimeout(() => ll.remove(), 1000);
      }
    }

    function launchHearts(amount) {
      for (let i = 0; i < amount; i++) {
        const h = document.createElement("div");
        h.className = "heart";
        h.textContent = "â¤ï¸";
        h.style.left = Math.random()*100 + "vw";
        h.style.animationDuration = (Math.random()*2 + 2) + "s";
        document.body.appendChild(h);
        setTimeout(() => h.remove(), 3000);
      }
    }

    function flashScreen() {
      const f = document.createElement("div");
      f.id = "flash";
      document.body.appendChild(f);
      setTimeout(() => f.remove(), 500);
    }

    function movePlayer(dx, dy) {
      const newX = playerX + dx, newY = playerY + dy;
      const nextCell = map[newY]?.[newX];
      if (nextCell === " " || nextCell === "E") {
        playerX = newX; playerY = newY;
        visited.add(`${newX},${newY}`);
        drawMap();
        moveSound.currentTime = 0;
        moveSound.play();
        spawnSparkle(newX, newY);
      }
      if (nextCell === "E") {
        setTimeout(() => {
          message.style.display = "flex";
          flashScreen();
          launchConfetti(200);
          spawnLargeSparkles(100);
          launchHearts(80);
        }, 400);
      }
    }

    document.addEventListener("keydown", e => {
      if (message.style.display === "flex") return;
      switch (e.key) {
        case "ArrowUp": case "w": movePlayer(0,-1); break;
        case "ArrowDown": case "s": movePlayer(0,1); break;
        case "ArrowLeft": case "a": movePlayer(-1,0); break;
        case "ArrowRight":case "d": movePlayer(1,0); break;
      }
    });

    function launchConfetti(amount) {
      for (let i = 0; i < amount; i++) {
        const c = document.createElement("div");
        c.className = "confetti";
        c.style.left = Math.random()*100+"vw";
        c.style.backgroundColor = randomPastel();
        c.style.animationDuration = (Math.random()*2+2)+"s";
        document.body.appendChild(c);
        setTimeout(() => c.remove(), 4000);
      }
    }
    function randomPastel() {
      const colors = ["#f8a5c2","#f6d186","#d3c0f9","#a8d5ba","#f5cd79","#e77f67"];
      return colors[Math.floor(Math.random()*colors.length)];
    }

    finalCard.addEventListener("click", () => {
      if (loveSong.paused) loveSong.play();
      else loveSong.pause();
    });

    restart.addEventListener("click", () => {
      // Reiniciar estado
      playerX = 1;
      playerY = 1;
      visited = new Set([`${playerX},${playerY}`]);
      loveSong.pause();
      loveSong.currentTime = 0;
      message.style.display = "none";
      drawMap();
    });

    drawMap();
  </script>
</body>
</html>
